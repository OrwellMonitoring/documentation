"use strict";(self.webpackChunkorwell_docs=self.webpackChunkorwell_docs||[]).push([[18],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return c}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,g=u["".concat(s,".").concat(c)]||u[c]||m[c]||l;return n?a.createElement(g,i(i({ref:t},d),{},{components:n})):a.createElement(g,i({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},8315:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return c},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return m}});var a=n(7462),r=n(3366),l=(n(7294),n(3905)),i=["components"],o={sidebar_position:1,custom_edit_url:null},s="System Agents",p={unversionedId:"deployment/system-agents",id:"deployment/system-agents",title:"System Agents",description:"ORWELL's main lifecycle depends on the communication of three big layers: the Storage/Visualization layer, the Middleware layer and the Translators layer. The deployment process revolves around containerizing the components that form each layer, providing a configurable environment for easy integration and adaptation to infrastructure changes.",source:"@site/docs/deployment/system-agents.md",sourceDirName:"deployment",slug:"/deployment/system-agents",permalink:"/documentation/deployment/system-agents",editUrl:null,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,custom_edit_url:null},sidebar:"tutorialSidebar",previous:{title:"Gnocchi Puller",permalink:"/documentation/core/gnocchi-puller"},next:{title:"Suricata",permalink:"/documentation/security/suricata"}},d={},m=[{value:"Storage/Visualization",id:"storagevisualization",level:2},{value:"Deployment",id:"deployment",level:4},{value:"Environment",id:"environment",level:4},{value:"Middleware",id:"middleware",level:2},{value:"Deployment",id:"deployment-1",level:4},{value:"Environment",id:"environment-1",level:4},{value:"Translators",id:"translators",level:2},{value:"Image",id:"image",level:4},{value:"Compose",id:"compose",level:4}],u={toc:m};function c(e){var t=e.components,n=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"system-agents"},"System Agents"),(0,l.kt)("p",null,"ORWELL's main lifecycle depends on the communication of three big layers: the Storage/Visualization layer, the Middleware layer and the Translators layer. The deployment process revolves around containerizing the components that form each layer, providing a configurable environment for easy integration and adaptation to infrastructure changes.  "),(0,l.kt)("h2",{id:"storagevisualization"},"Storage/Visualization"),(0,l.kt)("p",null,"This layer is composed of two services, a Prometheus instance which will contain the centralized metrics of the monitoring targets, integrated with Grafana, used for user visualization."),(0,l.kt)("h4",{id:"deployment"},"Deployment"),(0,l.kt)("p",null,"In our original deployment, this layer was running in a single machine, with the following docker-compose:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"services:\n  prometheus:\n    image: prom/prometheus:latest\n    volumes:\n      - ./prometheus/:/etc/prometheus/\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n    ports:\n      - 9090:9090\n    restart: always\n\n  grafana:\n    image: grafana/grafana\n    depends_on:\n      - prometheus\n    ports:\n      - 3000:3000\n    restart: always\n")),(0,l.kt)("h4",{id:"environment"},"Environment"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Variable"),(0,l.kt)("th",{parentName:"tr",align:null},"Used By"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"MIDDLEWARE_ENDPOINT"),(0,l.kt)("td",{parentName:"tr",align:null},"Prometheus"),(0,l.kt)("td",{parentName:"tr",align:null},"The endpoint Prometheus will use to fetch the metrics from the middleware (HTTP)")))),(0,l.kt)("h2",{id:"middleware"},"Middleware"),(0,l.kt)("p",null,"The middleware is the core of our system. We refer to Middleware as the aggregation of components that make possible the exporting of metrics to reach the Prometheus database, which are:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"REST API developed with FastAPI framework."),(0,l.kt)("li",{parentName:"ul"},"Redis cluster to cache exported metrics."),(0,l.kt)("li",{parentName:"ul"},"Kafka broker to better aggregate and handle the various translators' metric stream."),(0,l.kt)("li",{parentName:"ul"},"Postgres Database to store information about targets.")),(0,l.kt)("h4",{id:"deployment-1"},"Deployment"),(0,l.kt)("p",null,"All middleware components are deployed in the same machine. All these components could, however, be running on different machines, even different networks."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'services:\n  api:\n    build: ./middleware\n    depends_on:\n      postgres:\n        condition: service_healthy\n      redis:\n        condition: service_healthy\n    env_file: ./.env\n    environment:\n      - POSTGRES_HOST=postgres\n      - POSTGRES_DB=$POSTGRES_DB\n      - POSTGRES_USER=$POSTGRES_USER\n      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD\n      - REDIS_HOST=redis\n      - REDIS_PASSWPRD=$REDIS_PASSWORD\n    ports:\n      - $API_PORT:8000\n    healthcheck:\n      test: ["CMD-SHELL", "curl", "localhost:8000/"]\n      interval: 1s\n      timeout: 3s\n      retries: 30\n\n\n  postgres:\n    image: postgres:14.1-alpine\n    env_file: ./.env\n    environment:\n      - PGUSER=$POSTGRES_USER\n      - POSTGRES_DB=$POSTGRES_DB\n      - POSTGRES_USER=$POSTGRES_USER\n      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD\n    ports:\n      - $POSTGRES_PORT:5432\n    volumes:\n      - ./db:/docker-entrypoint-initdb.d\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready"]\n      interval: 1s\n      timeout: 3s\n      retries: 30\n\n  redis:\n    image: redis:6.2-alpine\n    restart: always\n    env_file: ./.env\n    ports:\n      - $REDIS_PORT:6379\n    command: redis-server --save 20 1 --loglevel warning --requirepass $REDIS_PASSWORD\n    healthcheck:\n      test: ["CMD", "redis-cli", "ping"]\n      interval: 1s\n      timeout: 3s\n      retries: 30\n\n  zookeeper:\n    image: bitnami/zookeeper:latest\n    ports:\n      - "$ZK_PORT:2181"\n    environment:\n      - ALLOW_ANONYMOUS_LOGIN=yes\n\n  kafka:\n    image: bitnami/kafka:latest\n    depends_on:\n      - zookeeper\n    ports:\n      - "$KAFKA_PORT:9092"\n      - "$KAFKA_LISTENER_PORT:9093"\n    environment:\n      - ALLOW_PLAINTEXT_LISTENER=yes\n      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181\n      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT\n      - KAFKA_CFG_LISTENERS=CLIENT://:9092,EXTERNAL://:$KAFKA_LISTENER_PORT\n      - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://kafka:9092,EXTERNAL://$KAFKA_HOST:$KAFKA_LISTENER_PORT\n      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=CLIENT\n    restart: unless-stopped\n\n')),(0,l.kt)("h4",{id:"environment-1"},"Environment"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Variable"),(0,l.kt)("th",{parentName:"tr",align:null},"Used By"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"API_PORT"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"Port the FastAPI will run on")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"REDIS_PORT"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Redis"),(0,l.kt)("td",{parentName:"tr",align:null},"Port Redis will run on")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"REDIS_PASSWORD"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Redis"),(0,l.kt)("td",{parentName:"tr",align:null},"Redis login credential")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POSTGRES_DB"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"Postgres database name")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POSTGRES_USER"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"Postgres credentials")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POSTGRES_PASSWORD"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"Postgres credentials")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POSTGRES_PORT"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI, Postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"Port running Postgres instance")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ZK_PORT"),(0,l.kt)("td",{parentName:"tr",align:null},"Kafka"),(0,l.kt)("td",{parentName:"tr",align:null},"Port running zookeeper instance")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"KAFKA_HOST"),(0,l.kt)("td",{parentName:"tr",align:null},"Kafka"),(0,l.kt)("td",{parentName:"tr",align:null},"Kafka Bootstrap address")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"KAFKA_PORT"),(0,l.kt)("td",{parentName:"tr",align:null},"Kafka"),(0,l.kt)("td",{parentName:"tr",align:null},"Kafka Bootstrap port")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OSM_HOST"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"OSM host address")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OSM_USER"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"OSM credentials")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OSM_PWD"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"OSM credentials")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OSM_PROJECT"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"OSM project name")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OPENSTACK_HOST"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"Openstack host address")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OPENSTACK_ID"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"Openstack credentials")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"OPENSTACK_SECRET"),(0,l.kt)("td",{parentName:"tr",align:null},"FastAPI"),(0,l.kt)("td",{parentName:"tr",align:null},"Openstack credentials")))),(0,l.kt)("h2",{id:"translators"},"Translators"),(0,l.kt)("p",null,"Each translator is containerized in a python image, making it possible to deploy any number of translators in any node of the network, contributing for the scalability of the system. For testing purposes, we provide a compose file deploying one of each translator developed."),(0,l.kt)("h4",{id:"image"},"Image"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'FROM python:3.8-slim-buster\n\nCOPY requirements.txt requirements.txt\n\nRUN pip3 install -r requirements.txt\n\nCOPY . .\n\nCMD ["python3", "main.py", "prod"]\n\n')),(0,l.kt)("h4",{id:"compose"},"Compose"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'version: "3.0"\nservices:\n  gnocchi:\n    build: "./gnochi"\n    environment:\n      KAFKA_TOPIC: "gnocchi"\n      KAFKA_HOST: "10.0.12.82"\n      REDIS_HOST: "10.0.12.82"\n  netdata:\n    build: "./netdata"\n    environment:\n      KAFKA_TOPIC: "netdata"\n      KAFKA_HOST: "10.0.12.82"\n      REDIS_HOST: "10.0.12.82"\n  prometheus:\n    build: "./node_exporter"\n    environment:\n      KAFKA_TOPIC: "prometheus"\n      KAFKA_HOST: "10.0.12.82"\n      REDIS_HOST: "10.0.12.82"\n    restart: always\n  telegraf:\n    build: "./telegraf"\n    environment:\n      KAFKA_TOPIC: "telegraf"\n      KAFKA_HOST: "10.0.12.82"\n      REDIS_HOST: "10.0.12.82"\n\n')))}c.isMDXComponent=!0}}]);